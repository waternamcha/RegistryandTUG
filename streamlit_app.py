import streamlit as st
import time
from datetime import datetime

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö & Design ---
st.set_page_config(page_title="Prosthesis Registry & OM", page_icon="ü¶ø", layout="wide")

st.markdown("""
    <style>
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ */
    div[data-testid="stMetricValue"] {
        font-size: 70px !important;
        font-family: 'Courier New', monospace;
        font-weight: 700;
        color: #1F618D;
    }
    /* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Expanders */
    .streamlit-expanderHeader {
        background-color: #EBF5FB;
        font-weight: bold;
        color: #154360;
    }
    /* Radio Button ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    div.row-widget.stRadio > div {
        flex-direction: row;
        align-items: stretch;
    }
    </style>
    """, unsafe_allow_html=True)

# --- 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Lists) ---
THAI_PROVINCES = [
    "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó",
    "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤",
    "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå",
    "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå",
    "‡πÅ‡∏û‡∏£‡πà", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ",
    "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡πÄ‡∏•‡∏¢", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£",
    "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π",
    "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"
]

COUNTRIES = ["Thailand", "United States", "United Kingdom", "Japan", "China", "Germany", "France", "Australia", 
             "Laos", "Myanmar", "Cambodia", "Vietnam", "Malaysia", "Singapore", "Other"]

current_year_be = datetime.now().year + 543
YEARS_LIST = list(range(current_year_be, current_year_be - 100, -1))

PROBLEM_LEVELS = [
    "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (0-4%)", 
    "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (5-24%)", 
    "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (25-49%)", 
    "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏°‡∏≤‡∏Å (50-95%)", 
    "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (96-100%)"
]

st.title("ü¶ø Digital Prosthesis Registry & OM Platform")

tab1, tab2 = st.tabs(["üìã Patient Registry (‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", "‚è±Ô∏è TUG Test (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏ô)"])

# =========================================================
# üìå TAB 1: Patient Registry (Fixed "Other" Inputs)
# =========================================================
with tab1:
    st.header("‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°")

    # --- PART 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
    with st.expander("üë§ 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Info)", expanded=True):
        col1, col2, col3 = st.columns(3)
        with col1:
            birth_year = st.selectbox("1. ‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î (‡∏û.‡∏®.)", YEARS_LIST, index=40)
            calc_age = current_year_be - birth_year
            st.caption(f"‡∏≠‡∏≤‡∏¢‡∏∏: {calc_age} ‡∏õ‡∏µ")
            
            gender = st.selectbox("2. ‡πÄ‡∏û‡∏®", ["‡∏ä‡∏≤‡∏¢", "‡∏´‡∏ç‡∏¥‡∏á"])
            
            country = st.selectbox("3. ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢", COUNTRIES)
            if country == "Other":
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", key="country_ot")

        with col2:
            province = st.selectbox("4. ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢", THAI_PROVINCES)
            
            # ‡πÅ‡∏Å‡πâ: ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥‡∏°‡∏µ Other
            nat_choice = st.selectbox("5. ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥", ["‡πÑ‡∏ó‡∏¢", "Other"])
            if nat_choice == "Other":
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥", key="nat_ot")
            
            hn = st.text_input("6. ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (HN)")
        
        with col3:
            weight = st.number_input("7. ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)", 0.0, 200.0, 60.0)
            height = st.number_input("8. ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)", 0, 250, 170)

    # --- PART 2: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Ç‡∏≤ ---
    with st.expander("üè• 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"):
        c1, c2 = st.columns(2)
        with c1:
            # ‡∏Ç‡πâ‡∏≠ 9
            comorb = st.multiselect("9. ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß", ["‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á", "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à", "‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï", "‡πÑ‡∏°‡πà‡∏°‡∏µ", "Other"])
            if "Other" in comorb: 
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="comorb_ot")
            
            # ‡∏Ç‡πâ‡∏≠ 10
            cause = st.selectbox("10. ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Ç‡∏≤", ["‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏", "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î", "‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á", "‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠", "‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î", "Other"])
            if cause == "Other": 
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="cause_ot")
            
            # ‡∏Ç‡πâ‡∏≠ 11
            amp_year = st.number_input("11. ‡∏õ‡∏µ (‡∏û.‡∏®.) ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏Ç‡∏≤", 2490, 2600, 2566)
            
            # ‡∏Ç‡πâ‡∏≠ 12
            side = st.radio("12. ‡∏Ç‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î", ["‡∏ã‡πâ‡∏≤‡∏¢", "‡∏Ç‡∏ß‡∏≤", "‡∏™‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á"], horizontal=True)

        with c2:
            # ‡∏Ç‡πâ‡∏≠ 13
            amp_level = st.selectbox("13. ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Ç‡∏≤", ["Ankle disarticulation", "Transtibial", "Knee disarticulation", "Transfemoral", "Hip disarticulation", "Other"])
            if amp_level == "Other": 
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏Ç‡∏≤", key="level_ot")

            # ‡∏Ç‡πâ‡∏≠ 14-15
            sub_c1, sub_c2 = st.columns(2)
            with sub_c1:
                stump_len = st.selectbox("14. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏≠‡∏Ç‡∏≤", ["‡∏™‡∏±‡πâ‡∏ô", "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", "‡∏¢‡∏≤‡∏ß"])
            with sub_c2:
                stump_shape = st.selectbox("15. ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ï‡∏≠‡∏Ç‡∏≤", ["Conical", "Cylindrical", "Bulbous", "Other"])
                if stump_shape == "Other": 
                    st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á", key="shape_ot")
            
            # ‡∏Ç‡πâ‡∏≠ 16
            surgery = st.radio("16. ‡πÄ‡∏Ñ‡∏¢‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≠‡∏Ç‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ["‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà", "‡πÉ‡∏ä‡πà"])
            if surgery == "‡πÉ‡∏ä‡πà":
                surg_details = st.multiselect("16.1 ‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î", ["‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å", "‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á", "‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô", "Other"])
                if "Other" in surg_details:
                    st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="surg_ot")
            
            # ‡∏Ç‡πâ‡∏≠ 17
            k_level = st.selectbox("17. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡∏Ç‡∏≤ (K-level)", ["K0", "K1", "K2", "K3", "K4"])

    # --- PART 3: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π ---
    with st.expander("ü©∫ 3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π"):
        # ‡∏Ç‡πâ‡∏≠ 18
        personnel = st.multiselect("18. ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏ó‡πà‡∏≤‡∏ô", 
            ["‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î", "‡∏ô‡∏±‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ö‡∏≥‡∏ö‡∏±‡∏î", "‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π", "‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", "‡∏ô‡∏±‡∏Å‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "Other"])
        if "Other" in personnel:
            st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="person_ot")
        
        # ‡∏Ç‡πâ‡∏≠ 19
        rehab_status = st.radio("19. ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ["‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢", "‡πÄ‡∏Ñ‡∏¢"])
        if rehab_status == "‡πÄ‡∏Ñ‡∏¢":
            activities = st.multiselect("19.1 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥", ["‡∏™‡∏ß‡∏°‡∏ñ‡∏∏‡∏á‡∏•‡∏î‡∏ö‡∏ß‡∏° (Shrinker)", "‡∏û‡∏±‡∏ô‡∏ú‡πâ‡∏≤‡∏¢‡∏∑‡∏î", "‡πÉ‡∏™‡πà‡πÄ‡∏ö‡πâ‡∏≤‡∏ã‡∏¥‡∏•‡∏¥‡πÇ‡∏Ñ‡∏ô", "‡∏ù‡∏∂‡∏Å‡πÄ‡∏î‡∏¥‡∏ô", "‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢", "Other"])
            if "Other" in activities:
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="act_ot")

    # --- PART 4: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ---
    with st.expander("ü¶æ 4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"):
        # ‡∏Ç‡πâ‡∏≠ 20
        service = st.multiselect("20. ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ", ["‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡πâ‡∏≤", "‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô", "Other"])
        if "Other" in service:
            st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="service_ot")
        
        d1, d2 = st.columns(2)
        with d1:
            st.date_input("21. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡πà‡∏≠‡πÅ‡∏ö‡∏ö (Casting Date)")
        with d2:
            st.date_input("22. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Delivery Date)")
        
        st.divider()
        st.markdown("**‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Components)**")
        
        # Logic Socket (‡∏Ç‡πâ‡∏≠ 23)
        socket_opts = ["Other"]
        if amp_level == "Transtibial":
            socket_opts = ["PTB", "TSB", "Osseointegration", "Other"]
        elif amp_level == "Transfemoral":
            socket_opts = ["Quadrilateral", "Ischial Containment", "Sub Ischial", "Osseointegration", "Other"]
        elif amp_level == "Knee disarticulation":
             socket_opts = ["Window opening", "Pad support", "Other"]

        c_comp1, c_comp2 = st.columns(2)
        with c_comp1:
            # ‡∏Ç‡πâ‡∏≠ 23
            sock = st.selectbox("23. ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏ö‡πâ‡∏≤ (Socket)", socket_opts)
            if sock == "Other": 
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏ö‡πâ‡∏≤", key="sock_ot")
            
            # ‡∏Ç‡πâ‡∏≠ 24
            liner = st.multiselect("24. Liner", ["No liner", "Foam/Pelite", "Silicone", "Gel (TPE)", "Polyurethane", "Socks", "Other"])
            if "Other" in liner:
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏ Liner ‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="liner_ot")
        
        with c_comp2:
            # ‡∏Ç‡πâ‡∏≠ 25
            susp = st.multiselect("25. ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∂‡∏î (Suspension)", ["Suction", "Pin lock", "Lanyard", "Sleeve", "Cuff/Strap", "Vacuum", "Belt", "Other"])
            if "Other" in susp:
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∂‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="susp_ot")
            
            # ‡∏Ç‡πâ‡∏≠ 26
            foot = st.multiselect("26. ‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Foot)", ["SACH", "Single axis", "Multiaxial", "Dynamic Response", "Hydraulic", "Microprocessor", "Other"])
            if "Other" in foot:
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="foot_ot")

        # ‡∏Ç‡πâ‡∏≠ 27 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á)
        if amp_level in ["Transfemoral", "Knee disarticulation", "Hip disarticulation"]:
            knee = st.multiselect("27. ‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Knee)", ["Single axis", "Polycentric", "Lock knee", "Weight-activated brake", "Hydraulic", "Pneumatic", "Microprocessor", "Other"])
            if "Other" in knee:
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="knee_ot")

    # --- PART 5: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
    with st.expander("üåç 5. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"):
        sc1, sc2 = st.columns(2)
        with sc1:
            # ‡∏Ç‡πâ‡∏≠ 28
            assist = st.selectbox("28. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏î‡∏¥‡∏ô", ["‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ", "‡πÑ‡∏°‡πâ‡πÄ‡∏ó‡πâ‡∏≤ (Cane)", "‡πÑ‡∏°‡πâ‡∏Ñ‡πâ‡∏≥‡∏¢‡∏±‡∏ô (Crutch)", "Walker", "Wheelchair", "Other"])
            if assist == "Other":
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="assist_ot")

            # ‡∏Ç‡πâ‡∏≠ 29
            st.selectbox("29.1 ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ '‡∏¢‡∏∑‡∏ô' ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô", ["‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏ô‡πÄ‡∏•‡∏¢", "< 1 ‡∏ä‡∏°.", "1-3 ‡∏ä‡∏°.", "3-7 ‡∏ä‡∏°.", "> 8 ‡∏ä‡∏°."])
            st.selectbox("29.2 ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ '‡πÄ‡∏î‡∏¥‡∏ô' ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô", ["‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡∏¢", "< 1 ‡∏ä‡∏°.", "1-3 ‡∏ä‡∏°.", "3-7 ‡∏ä‡∏°.", "> 8 ‡∏ä‡∏°."])
        
        with sc2:
            # ‡∏Ç‡πâ‡∏≠ 30
            fall = st.radio("30. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏° (‡πÉ‡∏ô 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)", ["‡πÑ‡∏°‡πà‡∏°‡∏µ", "‡∏°‡∏µ"])
            if fall == "‡∏°‡∏µ":
                st.selectbox("30.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°", ["< 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "3-4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "> 4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á"])
                st.checkbox("30.2 ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°")

        st.divider()
        st.markdown("#### ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (Self-Evaluation)")
        
        # ‡∏Ç‡πâ‡∏≠ 31
        st.write("31.1 ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)")
        st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏Ç‡πâ‡∏≠ 31.1)", PROBLEM_LEVELS, key="q31_1", horizontal=True)
        
        st.write("31.2 ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)")
        st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏Ç‡πâ‡∏≠ 31.2)", PROBLEM_LEVELS, key="q31_2", horizontal=True)

        st.markdown("---")
        
        # ‡∏Ç‡πâ‡∏≠ 32
        st.write("32.1 ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)")
        st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏Ç‡πâ‡∏≠ 32.1)", PROBLEM_LEVELS, key="q32_1", horizontal=True)
        
        st.write("32.2 ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)")
        st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏Ç‡πâ‡∏≠ 32.2)", PROBLEM_LEVELS, key="q32_2", horizontal=True)

        st.markdown("---")
        # ‡∏Ç‡πâ‡∏≠ 33
        st.markdown("#### 33. ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô (Support)")
        st.radio("33.1 ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", ["‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà", "‡πÉ‡∏ä‡πà"])
        
        supp_org = st.radio("33.2 ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏Å‡∏≤‡∏£, ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)", ["‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà", "‡πÉ‡∏ä‡πà"])
        if supp_org == "‡πÉ‡∏ä‡πà":
            sources = st.multiselect("‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô", ["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê", "‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£", "Other"])
            if "Other" in sources:
                st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ", key="supp_ot")

    if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (SAVE REGISTRY)", type="primary", use_container_width=True):
        st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∏‡∏ì {fname} (HN: {hn}) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")


# =========================================================
# üìå TAB 2: TUG Test (Stopwatch + Manual Input + Auto Calc)
# =========================================================
with tab2:
    st.header("‚è±Ô∏è Timed Up and Go (TUG)")
    st.info("üí° **‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:** ‡∏Å‡∏î Start/Stop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ -> ‡∏ô‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ -> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")
    
    # Init Session State (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤)
    if 'is_running' not in st.session_state: st.session_state.is_running = False
    if 'start_time' not in st.session_state: st.session_state.start_time = None
    if 'stopwatch_value' not in st.session_state: st.session_state.stopwatch_value = 0.0

    c_left, c_right = st.columns([1.5, 1])

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ (Left Column) ---
    with c_left:
        st.subheader("Stopwatch")
        
        # Display Clock
        with st.container(border=True):
            @st.fragment(run_every=0.1)
            def live_clock():
                if st.session_state.is_running:
                    elapsed = time.time() - st.session_state.start_time
                    st.metric("Time", f"{elapsed:.2f} s")
                else:
                    st.metric("Time", f"{st.session_state.stopwatch_value:.2f} s")
            live_clock()

        # Buttons
        b1, b2, b3 = st.columns(3)
        with b1:
            if st.button("‚ñ∂Ô∏è START", type="primary", use_container_width=True, 
                         disabled=st.session_state.is_running):
                st.session_state.is_running = True
                st.session_state.start_time = time.time()
                st.rerun()
        
        with b2:
            if st.button("‚è∏Ô∏è STOP", type="secondary", use_container_width=True, 
                         disabled=not st.session_state.is_running):
                st.session_state.is_running = False
                st.session_state.stopwatch_value = time.time() - st.session_state.start_time
                st.rerun()

        with b3:
            if st.button("üîÑ RESET Clock", use_container_width=True):
                st.session_state.is_running = False
                st.session_state.stopwatch_value = 0.0
                st.rerun()

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Right Column) ---
    with c_right:
        st.subheader("üìù Record & Result")
        
        # ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à/‡∏Å‡∏î Enter)
        t1 = st.number_input("Trial 1 (s)", min_value=0.0, step=0.01, format="%.2f", key="t1")
        t2 = st.number_input("Trial 2 (s)", min_value=0.0, step=0.01, format="%.2f", key="t2")
        t3 = st.number_input("Trial 3 (s)", min_value=0.0, step=0.01, format="%.2f", key="t3")

        st.divider()

        # Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î‡πÜ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Rerun)
        valid_trials = [t for t in [t1, t2, t3] if t > 0]
        
        if valid_trials:
            avg_time = sum(valid_trials) / len(valid_trials)
            
            # ‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡∏£‡∏î
            is_risk = avg_time >= 13.5
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            st.markdown("##### üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏ú‡∏• (Interpretation)")
            
            if is_risk:
                st.markdown(f"""
                <div class="result-box-risk">
                    <h3>‚ö†Ô∏è High Fall Risk</h3>
                    <h1 style="color:#C0392B; margin:0;">{avg_time:.2f} s</h1>
                    <p>(Average Time >= 13.5 s)</p>
                </div>
                """, unsafe_allow_html=True)
            else:
                st.markdown(f"""
                <div class="result-box-normal">
                    <h3>‚úÖ Normal Mobility</h3>
                    <h1 style="color:#28B463; margin:0;">{avg_time:.2f} s</h1>
                    <p>(Average Time < 13.5 s)</p>
                </div>
                """, unsafe_allow_html=True)
            
            st.caption("‚ÑπÔ∏è MDC (Minimal Detectable Change): 3.6 seconds")
            
        else:
            st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå")